<% html_title(l(:label_issue_templates)) %>

<div class="contextual">
  <%= link_to(l(:label_new_templates),
                            {:controller => 'issue_templates', :action => 'init', :project_id => @project ? @project : nil},
                            :class => 'icon icon-add', :method => :post) if @project %>
</div>

<h2 class="template"><%=h "#{l(:label_issue_templates)} : #{@project}" %></h2>

<% if @notice -%>
  <div class="flash notice"><%= @notice -%></div>
<% end -%>

<% if @templates.empty? %>
  <div class="template_box">
    <%= l(:no_issue_templates_for_this_project) %>
  </div>
<% else %>

  <div class="template_box">

    <table class="list issues">
      <thead>
      <tr>
        <th class="template_id"><%= l(:field_tracker) %></th>
        <th class="template_title"><%= l(:field_template_title) %></th>
        <th class="template_subject"><%= l(:field_subject) %></th>
        <th class="template_projects"><%= l(:field_project).pluralize %></th>
        <th class="template_enable"><%= l(:label_enabled) %></th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <% @templates.each do |issue_template| %>
        <tr class="<%= cycle("odd", "even") %> issue_template issue">
          <% link_to_edition = Proc.new do |label, title|
            size_max = 40
            label = "#{label.first(size_max)}..." if label.size > size_max
            link_to label.html_safe, {:controller => 'issue_templates',
                                      :action => 'edit',
                                      :id => issue_template.id
                                      # ,:project_id => project.id
            }, {:title => title }
          end %>
          <td><%= link_to_edition.call h(issue_template.tracker.name), issue_template.tracker.name %></td>
          <td><%= link_to_edition.call h(issue_template.template_title), issue_template.template_title %></td>
          <td><%= link_to_edition.call h(issue_template.subject), issue_template.subject %></td>
          <td><% issue_template.projects.each do |project| %>
                  <%= link_to project.name, issue_templates_path("project_id" => project.id), class: "project_id_#{project.id} list_templates_projects_names" %>
              <% end %>
          </td>
          <td class="center image_enabled_<%= issue_template.id %>">
            <%= render "enable_form", issue_template: issue_template %>
          </td>
          <td class="buttons">
            <% if true  #User.current.allowed_to?(:manage_templates, project) %>
              <%= link_to l(:button_edit), edit_issue_template_path(id: issue_template.id
              #, project_id: project.id
              ), :class => 'icon icon-edit' %>
              <%= delete_link issue_template_path(issue_template) %>
            <% end %>
          </td>
        </tr>
      <% end %>
      <% reset_cycle %>
      </tbody>
    </table>
  </div>

<% end %>

<% if @project && !@project.children.blank? %>
  <BR/>
  <h2><%=h "#{l(:show_subprojects_templates)}" %></h2>
<% end %>

<% @project.children.each do |subproject| %>
  <% unless @templates.blank? && subproject.children.blank? %>
    <div style="margin-left: 20px">
      <H4><%= link_to "#{subproject.name}", issue_templates_path("project_id" => subproject.id) %></H4>
    </div>
  <% end %>
<% end if @project %>
